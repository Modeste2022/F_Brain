name: CD - Promote dev to master

on:
  push:
    branches:
      - dev
  workflow_dispatch:
    inputs:
      force_promotion:
        description: 'Forcer la promotion m√™me sans changements'
        required: false
        default: 'false'
        type: boolean
      delay_seconds:
        description: 'D√©lai avant merge automatique (secondes)'
        required: false
        default: '30'
        type: string

permissions:
  contents: write
  pull-requests: write
  checks: read
  actions: read

env:
  PROMOTION_DELAY: ${{ github.event.inputs.delay_seconds || '30' }}

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      validation-status: ${{ steps.validation-check.outputs.status }}
      commits-count: ${{ steps.diff-check.outputs.commits-ahead }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Validate Docker setup
        run: |
          if [ -f docker-compose.yml ]; then
            docker compose config --quiet
            docker compose build --quiet
          fi

      - name: Check differences
        id: diff-check
        run: |
          git fetch origin master
          DIFF_COUNT=$(git rev-list --count origin/master..HEAD)
          echo "commits-ahead=$DIFF_COUNT" >> $GITHUB_OUTPUT
          [ "$DIFF_COUNT" -gt 0 ] || [ "${{ github.event.inputs.force_promotion }}" = "true" ]
          echo "has-changes=$?" >> $GITHUB_OUTPUT

      - name: Check merge conflicts
        run: |
          git merge-tree $(git merge-base HEAD origin/master) HEAD origin/master | 
          grep -q '<<<<<<<' && exit 1 || exit 0

      - name: Validation summary
        id: validation-check
        run: |
          if [ "${{ steps.diff-check.outputs.has-changes }}" = "1" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=skipped" >> $GITHUB_OUTPUT
          fi

  promote:
    needs: validate
    if: needs.validate.outputs.validation-status == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: dev
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Setup Git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Find or create PR
        id: pr-management
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          # Trouver une PR existante
          PR_INFO=$(gh pr list --head dev --base master --state open --json number,title)
          if [ "$(echo "$PR_INFO" | jq length)" -gt 0 ]; then
            pr_number=$(echo "$PR_INFO" | jq -r '.[0].number')
            echo "‚ôªÔ∏è PR existante #$pr_number"
          else
            # Cr√©er une nouvelle PR (m√©thode compatible)
            pr_url=$(gh pr create \
              --head dev \
              --base master \
              --title "üöÄ Promotion auto: dev ‚Üí master" \
              --body "Promotion automatique - Valid√©e par CI")
            pr_number=$(echo "$pr_url" | grep -oE '/pull/[0-9]+' | cut -d'/' -f3)
            echo "‚úÖ Nouvelle PR #$pr_number"
          fi
          echo "pr-number=$pr_number" >> $GITHUB_OUTPUT

      - name: Wait before merge
        run: sleep ${{ env.PROMOTION_DELAY }}

      - name: Merge PR
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          gh pr merge ${{ steps.pr-management.outputs.pr-number }} \
            --merge \
            --delete-branch=false \
            --body "Merg√© automatiquement par CD workflow"

  notify:
    needs: [validate, promote]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Summary
        run: |
          echo "CD Workflow Result: ${{ needs.promote.result || 'skipped' }}"
          echo "Commits promoted: ${{ needs.validate.outputs.commits-count || '0' }}"